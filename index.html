<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Facturation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f2f2f2;
    }
    .container {
      max-width: 900px;
      margin-top: 40px;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .select2-container {
      width: 100% !important;
    }
    .btn-primary {
      background-color: #0066d9;
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center text-primary">Dashboard de Facturation</h2>

  <div class="mb-3">
    <label for="ipp" class="form-label">IPP du Patient</label>
    <input type="text" class="form-control" id="ipp" placeholder="Ex: IPP-123456789">
    <button class="btn btn-sm btn-secondary mt-2" onclick="loadPatientInfo()">Charger le Patient</button>
  </div>

  <div id="patientInfo" class="mb-4" style="display:none;">
    <h5>Informations du Patient</h5>
    <p><strong>Nom:</strong> <span id="nom"></span></p>
    <p><strong>Prénom:</strong> <span id="prenom"></span></p>
    <p><strong>CIN:</strong> <span id="cin"></span></p>
    <p><strong>Téléphone:</strong> <span id="telephone"></span></p>
  </div>

  <div class="mb-3">
    <label class="form-label">Services Disponibles</label>
    <select id="services" class="form-control" multiple></select>
  </div>

  <div class="mb-3">
    <label class="form-label">Mode de Paiement</label>
    <select id="mode_paiement" class="form-select">
      <option value="espèces">Espèces</option>
      <option value="carte">Carte</option>
      <option value="virement">Virement</option>
    </select>
  </div>

  <div class="d-flex justify-content-between align-items-center">
    <h5>Total: <span id="total">0</span> MAD</h5>
    <div>
      <button class="btn btn-primary" onclick="createFacture()">Créer Facture</button>
      <button class="btn btn-success" onclick="markAsPaid()">Marquer comme Payé</button>
    </div>
  </div>
</div>

<script>
  const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWlkIjoiZmJmMmI1ZjctZTc3ZS00ZGZmLWJlN2UtN2ZlOGVkZmViZmY1IiwiZmlyc3ROYW1lIjoiTW91c3NhIiwibGFzdE5hbWUiOiJTYWlkaSIsInVzZXJuYW1lIjoic2FpZGkiLCJlbWFpbCI6Im1vdXNzYS5zYWlkaS4wMUBnbXppbC5jb20iLCJwYXNzd29yZCI6ImFkbWluMTIzNCIsInJvbGUiOiJBZG1pbiIsImlhdCI6MTc0Mjk1MjMyNn0.1s_IWO-h-AKwkP0LIX8mcjdeLRwsRtgbqAchIJSRVEA";
  let selectedServices = [];
  let servicesData = [];
  let currentFactureId = null;

  async function loadServices() {
    try {
      const res = await axios.get("https://workflows.aphelionxinnovations.com/webhook/tarifs", {
        headers: { Authorization: `Bearer ${token}` }
      });
      servicesData = res.data.services;
      const serviceSelect = document.getElementById("services");
      servicesData.forEach(service => {
        const opt = document.createElement("option");
        opt.value = service.id;
        opt.textContent = `${service.name} - ${parseFloat(service.price).toFixed(2)} MAD`;
        serviceSelect.appendChild(opt);
      });
      $('#services').select2();
      $('#services').on('change', updateTotal);
    } catch (err) {
      alert("Erreur lors du chargement des services");
    }
  }

  function updateTotal() {
    selectedServices = $('#services').val();
    const total = servicesData
      .filter(s => selectedServices.includes(s.id.toString()))
      .reduce((acc, s) => acc + parseFloat(s.price), 0);
    document.getElementById("total").textContent = total.toFixed(2);
  }

  async function loadPatientInfo() {
    const ipp = document.getElementById("ipp").value;
    try {
      const res = await axios.get(`https://workflows.aphelionxinnovations.com/webhook/bill-get-patient?ipp=${ipp}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const p = res.data;
      document.getElementById("nom").textContent = p.nom;
      document.getElementById("prenom").textContent = p.prenom;
      document.getElementById("cin").textContent = p.cin;
      document.getElementById("telephone").textContent = p.telephone;
      document.getElementById("patientInfo").style.display = 'block';
    } catch (err) {
      alert("Patient non trouvé");
    }
  }

  async function createFacture() {
    const ipp = document.getElementById("ipp").value;
    const mode = document.getElementById("mode_paiement").value;
    try {
      const res = await axios.post("https://workflows.aphelionxinnovations.com/webhook/create-facture", {
        ipp,
        mode_paiement: mode,
        services: selectedServices.map(Number)
      }, {
        headers: { Authorization: `Bearer ${token}` }
      });
      alert("Facture créée avec succès");
      currentFactureId = res.data.facture_id;
    } catch (err) {
      alert("Erreur de création de la facture");
    }
  }

  async function markAsPaid() {
    if (!currentFactureId) return alert("Veuillez créer une facture d'abord.");
    try {
      await axios.post("https://workflows.aphelionxinnovations.com/webhook/facture/update-payment-status", {
        facture_id: currentFactureId,
        etat_paiement: "payé"
      }, {
        headers: { Authorization: `Bearer ${token}` }
      });
      alert("Facture marquée comme payée");
    } catch (err) {
      alert("Erreur lors de la mise à jour du statut de paiement");
    }
  }

  window.onload = loadServices;
</script>
</body>
</html>
