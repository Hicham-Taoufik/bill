<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Facturation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    h2 { color: #007bff; }
    .select2-container--default .select2-selection--multiple {
      height: auto;
    }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="text-center mb-4">Dashboard de Facturation</h2>

  <div id="patient-info" class="mb-4"></div>

  <div class="mb-3">
    <label class="form-label fw-bold">Services Disponibles</label>
    <select id="services" class="form-select" multiple></select>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">Mode de Paiement</label>
    <select id="mode-paiement" class="form-select">
      <option value="espèces">Espèces</option>
      <option value="carte">Carte</option>
      <option value="assurance">Assurance</option>
    </select>
  </div>

  <p class="fw-bold">Total: <span id="total">0</span> MAD</p>

  <button class="btn btn-primary" onclick="createFacture()">Créer Facture</button>
  <button class="btn btn-success" onclick="markAsPaid()">Marquer comme Payé</button>

  <h5 class="mt-5">Factures Existantes</h5>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>Montant</th>
        <th>Mode de Paiement</th>
        <th>Statut</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="factures-table">
      <tr><td colspan="5">Chargement des factures...</td></tr>
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  const baseUrl = 'https://workflows.aphelionxinnovations.com';
  const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWlkIjoiZmJmMmI1ZjctZTc3ZS00ZGZmLWJlN2UtN2ZlOGVkZmViZmY1IiwiZmlyc3ROYW1lIjoiTW91c3NhIiwibGFzdE5hbWUiOiJTYWlkaSIsInVzZXJuYW1lIjoic2FpZGkiLCJlbWFpbCI6Im1vdXNzYS5zYWlkaS4wMUBnbXppbC5jb20iLCJwYXNzd29yZCI6ImFkbWluMTIzNCIsInJvbGUiOiJBZG1pbiIsImlhdCI6MTc0Mjk1MjMyNn0.1s_IWO-h-AKwkP0LIX8mcjdeLRwsRtgbqAchIJSRVEA'; // Use your full token here
  const ipp = new URLSearchParams(window.location.search).get('ipp');

  const headers = { Authorization: `Bearer ${token}` };
  let selectedServices = [];
  let factureId = null;

  async function loadPatientInfo() {
    const res = await axios.get(`${baseUrl}/webhook/bill-get-patient?ipp=${ipp}`, { headers });
    const p = res.data;
    document.getElementById('patient-info').innerHTML = `
      <h5>Informations du Patient</h5>
      <p><strong>Nom:</strong> ${p.nom}</p>
      <p><strong>Prénom:</strong> ${p.prenom}</p>
      <p><strong>CIN:</strong> ${p.cin}</p>
      <p><strong>Téléphone:</strong> ${p.telephone}</p>
      <p><strong>Adresse:</strong> ${p.adresse}</p>
      <p><strong>Ville:</strong> ${p.ville}</p>
      <p><strong>Date de Naissance:</strong> ${p.date_naissance}</p>
      <p><strong>Sexe:</strong> ${p.sexe}</p>
      <p><strong>Mutuelle:</strong> ${p.mutuelle}</p>
    `;
  }

  async function loadServices() {
    const res = await axios.get(`${baseUrl}/webhook/tarifs`, { headers });
    const data = res.data.services;
    const select = document.getElementById('services');
    data.forEach(service => {
      const option = new Option(`${service.name} - ${service.price} MAD`, service.id, false, false);
      select.append(option);
    });
    $('#services').select2();
    $('#services').on('change', calculateTotal);
  }

  function calculateTotal() {
    selectedServices = $('#services').val().map(Number);
    const selectedOptions = [...document.getElementById('services').selectedOptions];
    const total = selectedOptions.reduce((sum, opt) => {
      const price = parseFloat(opt.textContent.split(' - ')[1]);
      return sum + price;
    }, 0);
    document.getElementById('total').innerText = total.toFixed(2);
  }

  async function createFacture() {
    const mode = document.getElementById('mode-paiement').value;
    const body = {
      ipp,
      mode_paiement: mode,
      services: selectedServices
    };
    const res = await axios.post(`${baseUrl}/webhook/create-facture`, body, { headers });
    alert(res.data.message);
    factureId = res.data.facture_id;
    loadFactures();
  }

  async function markAsPaid() {
    if (!factureId) return alert("Aucune facture disponible pour mettre à jour.");
    await axios.post(`${baseUrl}/webhook/facture/update-payment-status`, {
      facture_id: factureId,
      etat_paiement: 'payé'
    }, { headers });
    alert("Statut de paiement mis à jour");
    loadFactures();
  }

  async function loadFactures() {
    if (!factureId) return;
    const res = await axios.get(`${baseUrl}/webhook/facture/get?facture_id=${factureId}`, { headers });
    const f = res.data;
    document.getElementById('factures-table').innerHTML = `
      <tr>
        <td>${f.id}</td>
        <td>${f.montant}</td>
        <td>${f.mode_paiement}</td>
        <td>${f.etat_paiement}</td>
        <td>${new Date(f.date_facturation).toLocaleString()}</td>
      </tr>
    `;
  }

  window.onload = async () => {
    await loadPatientInfo();
    await loadServices();
  }
</script>
</body>
</html>
