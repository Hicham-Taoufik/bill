<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediClinic - Dashboard de Facturation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    /* --- Base CSS Styles (Unchanged) --- */
    :root { /* ... CSS Variables ... */ }
    body { /* ... body styles ... */ visibility: hidden; }
    body.loaded { visibility: visible; }
    .app-container { /* ... */ }
    .page-header { /* ... */ }
    /* --- Add styles for QR Scanner elements if needed, similar to Doctor dash --- */
     #scanner-container { /* Example basic style */
        display: none;
        position: relative;
        max-width: 300px; /* Adjust as needed */
        margin-top: 15px;
        border: 1px solid var(--light-gray);
        border-radius: var(--border-radius);
        overflow: hidden;
     }
     #scanner-video { display: block; width: 100%; height: auto; }
     .message-info { background: var(--primary-light); color: var(--primary-color); border-left: 4px solid var(--primary-color);} /* Add info style */
    /* --- All other existing CSS --- */
    .page-title { /* ... */ }
    .clinic-logo { /* ... */ }
    .card { /* ... */ }
    .card-header { /* ... */ }
    /* ... etc ... */
     .no-print { @media print { display: none !important; } }

  </style>
</head>
<body > <!-- Body starts hidden -->
  <div class="loader-container"> <div class="loader"></div> </div>
  <div class="app-container">
    <div class="page-header no-print">
        <h1 class="page-title">Dashboard de Facturation</h1>
        <div class="clinic-logo">
            <i class="fas fa-hospital-user"></i> MediClinic
            <button onclick="logout()" style="margin-left: 20px;" title="Déconnexion" class="btn btn-sm btn-outline"> <i class="fas fa-sign-out-alt"></i> </button>
        </div>
    </div>
    <div id="alertContainer" class="alert no-print" role="alert"></div>

    <!-- ADDED: QR Scanner Card -->
    <div class="card no-print">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-qrcode me-2"></i>Charger Patient via QR Code</h5>
            <div class="card-icon icon-patient"> <i class="fas fa-camera"></i> </div>
        </div>
        <div class="card-body">
             <div class="qr-scanner-section">
                <button id="scanQrButton" class="btn btn-primary"> <i class="fas fa-qrcode"></i> Scanner QR Patient </button>
                <div id="scanner-container">
                   <video id="scanner-video" playsinline></video>
                </div>
                <div id="scanResult" class="alert" style="margin-top: 15px;"></div> <!-- Use alert classes for messages -->
            </div>
        </div>
    </div>
    <!-- END: QR Scanner Card -->


    <div class="card no-print"> <!-- Added no-print here too -->
        <div class="card-header"> <h5 class="card-title">Informations du Patient</h5> <div class="card-icon icon-patient"> <i class="fas fa-user"></i> </div> </div>
        <div class="card-body"> <div id="patientInfo" class="patient-info"> <div class="empty-state"> <i class="fas fa-user-circle"></i> <div class="empty-state-message">Aucun patient chargé</div> <div class="empty-state-description">Scannez un QR code ou chargez un patient via l'URL (IPP).</div> </div> </div> </div>
    </div>
    <div class="card no-print"> <!-- Added no-print here too -->
        <div class="card-header"> <h5 class="card-title">Nouvelle Facture</h5> <div class="card-icon icon-invoice"> <i class="fas fa-file-invoice"></i> </div> </div>
        <div class="card-body" id="newInvoiceCardBody" style="opacity: 0.5; pointer-events: none;"> <!-- Initially disabled --> <div class="row"> <div class="col-md-8"> <div class="form-group mb-4"> <label for="services"><i class="fas fa-list-check me-2"></i>Services Disponibles</label> <select class="form-select" id="services" multiple disabled></select> </div> <div class="form-group mb-4"> <label for="modePaiement"><i class="fas fa-credit-card me-2"></i>Mode de Paiement</label> <select class="form-select" id="modePaiement" disabled> <option value="espèces">Espèces</option> <option value="carte">Carte Bancaire</option> <option value="assurance">Assurance</option> </select> </div> </div> <div class="col-md-4"> <div class="price-card"> <div class="price-label">Montant Total</div> <div class="price-value"><span id="total">0.00</span><span class="price-currency">MAD</span></div> <button id="creerFacture" class="btn btn-light w-100 mt-3" disabled> <i class="fas fa-plus-circle me-2"></i>Créer Facture </button> </div> </div> </div> </div>
    </div>
    <div class="card"> <!-- Keep history potentially printable -->
        <div class="card-header"> <h5 class="card-title">Historique des Factures</h5> <div class="card-icon icon-history"> <i class="fas fa-history"></i> </div> </div>
        <div class="card-body"> <div class="table-responsive"> <table class="table"> <thead> <tr> <th>ID</th> <th>Montant</th> <th>Mode de Paiement</th> <th>Statut</th> <th>Date</th> <th class="no-print" style="width: 25%;">Action</th> </tr> </thead> <tbody id="factureBody"> <tr> <td colspan="6" class="text-center">Chargez un patient pour voir l'historique.</td> </tr> </tbody> </table> </div> </div>
    </div>
  </div>

  <!-- Hidden div for PDF generation -->
  <div id="invoice-content-area" style="position: absolute; left: -9999px; top: -9999px;"></div>
  <!-- Hidden iframe for printing -->
  <iframe id="print-frame" name="print-frame" style="position:absolute;top:-9999px;left:-9999px;"></iframe>

   <!-- ADDED: jsQR Library Script (Adjust path if needed) -->
  <script src="./jsQR.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    // --- Configuration ---
    const baseUrl = "https://workflows.aphelionxinnovations.com";
    const LOGIN_PAGE_URL = 'https://hicham-taoufik.github.io/login/';
    const QR_TARGET_BASE_URL = 'app://medilink/patient'; // MUST MATCH RECEPTION

    const urlParams = new URLSearchParams(window.location.search);
    let currentIPP = urlParams.get("ipp"); // Allow IPP from URL initially

    const clinicInfo = { name: "MediClinic", address: "123 Rue de la Santé, Paris", phone: "+33 1 23 45 67 89" };
    let currentPatientInfo = null;

    // --- Auth & Helpers ---
    function fetchWithAuth(url, options={}) { /* ... Same as before ... */ }
    function logout() { /* ... Same as before ... */ }
    function showLoader() { /* ... */ }
    function hideLoader() { /* ... */ }
    function showAlert(message, type='danger') { /* ... Same as before ... */ }

    // --- API Service Layer --- (Uses fetchWithAuth)
    const apiService = { /* ... Same as before ... */ };

    // --- Formatters --- (No changes)
    function formatPaymentMode(mode) { /* ... */ }
    function getPaymentIcon(mode) { /* ... */ }
    function formatService(service) { /* ... */ }
    function formatServiceSelection(service) { /* ... */ }

    // --- Core UI Functions ---
    async function loadPatientInfo(patientIpp) {
        if (!patientIpp) { showAlert("IPP manquant pour charger le patient.", "warning"); return; }
        showLoader(); currentPatientInfo = null; // Reset previous patient
        try {
            const d = await apiService.fetchPatient(patientIpp);
            currentPatientInfo = d; // Store globally
            const patientInfoDiv = document.getElementById("patientInfo");
            // Clear empty state if present
            patientInfoDiv.innerHTML = '';
             // Populate using the grid structure (ensure styles target .patient-info)
            patientInfoDiv.innerHTML = `
                <div class="patient-info-item"> <div class="patient-info-label">Nom</div> <div class="patient-info-value" id="nom">${d.nom||'-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Prénom</div> <div class="patient-info-value" id="prenom">${d.prenom||'-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">CIN</div> <div class="patient-info-value" id="cin">${d.cin||'-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Téléphone</div> <div class="patient-info-value" id="telephone">${d.telephone||'-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Adresse</div> <div class="patient-info-value" id="adresse">${d.adresse||'-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Ville</div> <div class="patient-info-value" id="ville">${d.ville||'-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Naissance</div> <div class="patient-info-value" id="date_naissance">${d.date_naissance ? new Date(d.date_naissance+'T00:00:00Z').toLocaleDateString('fr-FR') : '-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Sexe</div> <div class="patient-info-value" id="sexe">${d.sexe === 'M' ? 'Homme' : d.sexe === 'F' ? 'Femme' : '-'}</div> </div>
                <div class="patient-info-item"> <div class="patient-info-label">Mutuelle</div> <div class="patient-info-value" id="mutuelle">${d.mutuelle||'Non'}</div> </div>
            `;
            // Enable invoice creation section
            enableInvoiceSection(true);
            // Load invoices for this patient
            await loadInvoices(patientIpp);

        } catch(e) {
            if(!e.message.startsWith('Auth')) { showAlert(`Erreur chargement patient (${patientIpp}): ${e.message}`); }
            enableInvoiceSection(false); // Disable section on error
            document.getElementById("patientInfo").innerHTML = '<div class="empty-state"><i class="fas fa-user-times"></i><div class="empty-state-message">Impossible de charger le patient</div></div>';
            document.getElementById("factureBody").innerHTML = '<tr><td colspan="6" class="text-center">Impossible de charger l\'historique.</td></tr>';
        } finally { hideLoader(); }
    }

    async function loadServices() { /* ... Same as before (uses apiService) ... */ }
    function updateTotal() { /* ... Same as before ... */ }

    function enableInvoiceSection(enable) {
        const cardBody = document.getElementById('newInvoiceCardBody');
        const servicesSelect = document.getElementById('services');
        const paymentSelect = document.getElementById('modePaiement');
        const createButton = document.getElementById('creerFacture');

        if (enable) {
            cardBody.style.opacity = '1';
            cardBody.style.pointerEvents = 'auto';
            if(servicesSelect) servicesSelect.disabled = false;
            if(paymentSelect) paymentSelect.disabled = false;
            if(createButton) createButton.disabled = false;
        } else {
            cardBody.style.opacity = '0.5';
            cardBody.style.pointerEvents = 'none';
             if(servicesSelect) servicesSelect.disabled = true;
            if(paymentSelect) paymentSelect.disabled = true;
            if(createButton) createButton.disabled = true;
             $('#services').val(null).trigger('change'); // Clear services
            updateTotal(); // Reset total
        }
    }

    async function createInvoice() { /* ... Same as before (uses apiService) ... */ }
    async function loadInvoices(patientIpp) { /* ... Updated version from before (uses apiService) ... */ }
    async function updateInvoiceStatus(id, status) { /* ... Same as before (uses apiService) ... */ }
    function generateInvoiceHtml(invoiceDetails, patientInfo, clinicDetails) { /* ... Same as before ... */ }
    async function handleDownloadPdf(factureId) { /* ... Same as before (uses apiService) ... */ }
    async function handlePrintInvoice(factureId) { /* ... Same as before (uses apiService) ... */ }


    // --- QR SCANNER CODE --- (Copied from Doctor/Nurse, adapted loadPatient call)
    const scanButton = document.getElementById('scanQrButton');
    const scannerContainer = document.getElementById('scanner-container');
    const video = document.getElementById('scanner-video');
    const scanResultDiv = document.getElementById("scanResult");
    let scanning = false;
    let currentStream = null;
    let scanTimeout = null;

     function updateScanStatus(message, type = 'info') {
        const statusTypes={'info':{icon:'fas fa-info-circle',cls:'alert-info'},'success':{icon:'fas fa-check-circle',cls:'alert-success'},'warning':{icon:'fas fa-exclamation-triangle',cls:'alert-warning'},'error':{icon:'fas fa-times-circle',cls:'alert-danger'},'loading':{icon:'fas fa-spinner fa-spin',cls:'alert-info'}}; const sInfo=statusTypes[type]||statusTypes['info'];
        scanResultDiv.className = `alert ${sInfo.cls} no-print`; // Use alert classes
        scanResultDiv.innerHTML = `<i class="${sInfo.icon} me-2"></i>${message}`;
        scanResultDiv.style.display = message ? 'block' : 'none';
    }

    if (scanButton) {
         scanButton.onclick = async () => {
            if (!scanning) { // Start Scan
                try {
                    updateScanStatus(''); // Clear previous scan messages
                    scannerContainer.style.display = 'block';
                    updateScanStatus('Recherche caméra...', 'loading');
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = currentStream; await video.play();
                    updateScanStatus('Caméra prête. Scannez le code.', 'info');
                    scanButton.innerHTML = '<i class="fas fa-stop-circle"></i> Arrêter Scan'; scanButton.classList.replace('btn-primary','btn-danger'); scanning = true;
                    clearTimeout(scanTimeout); scanTimeout = setTimeout(() => { if (scanning) { updateScanStatus('Aucun code détecté.', 'warning'); stopScanner(); } }, 30000);
                    requestAnimationFrame(tick);
                } catch (err) { console.error("Cam Err:", err); updateScanStatus(`Err Cam: ${err.message}`, 'error'); stopScanner(); }
            } else { stopScanner(); updateScanStatus('Scan arrêté.', 'info'); } // Stop Scan
        };
    } else { console.warn("Scan button not found."); }

    function stopScanner() { clearTimeout(scanTimeout); if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); } video.srcObject = null; scannerContainer.style.display = 'none'; if(scanButton) {scanButton.innerHTML = '<i class="fas fa-qrcode"></i> Scanner QR Patient'; scanButton.classList.replace('btn-danger','btn-primary');} scanning = false; currentStream = null; }

    function tick() { if (!scanning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { if (scanning) requestAnimationFrame(tick); return; } const tce = document.createElement('canvas'); tce.height = video.videoHeight; tce.width = video.videoWidth; const tc = tce.getContext("2d"); tc.drawImage(video, 0, 0, tce.width, tce.height); const id = tc.getImageData(0, 0, tce.width, tce.height); const code = window.jsQR(id.data, id.width, id.height, { inversionAttempts: "dontInvert" }); if (code) { console.log("QR Found:", code.data); stopScanner(); processScannedQrCode(code.data); } else { requestAnimationFrame(tick); } }

    function processScannedQrCode(scannedUrl) { clearTimeout(scanTimeout); updateScanStatus('Code détecté. Traitement...', 'loading'); try { const url = new URL(scannedUrl); let ubp = ''; if (url.protocol === 'app:') { ubp = url.protocol + '//' + url.hostname + url.pathname; } else { ubp = url.origin + url.pathname; } console.log(`Compare Scan Base: "${ubp}" vs Expected: "${QR_TARGET_BASE_URL}"`); if (scannedUrl.startsWith(QR_TARGET_BASE_URL)) { const ippFromQr = url.searchParams.get('ipp'); console.log("Attempting to get IPP. Found:", ippFromQr); if (ippFromQr) { console.log("IPP Found:", ippFromQr); updateScanStatus(`Patient IPP ${ippFromQr} trouvé. Chargement...`, 'success'); loadPatientIntoCurrentDashboard(ippFromQr); } else { console.error("IPP missing."); updateScanStatus('Erreur: IPP manquant.', 'error'); } } else { console.error("Base URL mismatch."); updateScanStatus('Erreur: QR Code non reconnu.', 'error'); } } catch (e) { console.error("Error processing scan:", e); updateScanStatus(`Erreur: Format QR invalide (${e.message}).`, 'error'); } }

    function loadPatientIntoCurrentDashboard(scannedIpp) {
        console.log(`Loading patient ${scannedIpp} into Billing dashboard`);
        currentIPP = scannedIpp; // Update the global IPP
        // Update URL without reloading
        try { const newUrl = new URL(window.location); newUrl.searchParams.set('ipp', scannedIpp); window.history.pushState({ ipp: scannedIpp }, '', newUrl); } catch(e) { console.error("History API err:", e); }
        // Load patient info and their invoices
        loadPatientInfo(scannedIpp);
        // loadInvoices(scannedIpp); // loadPatientInfo now calls loadInvoices
        // Clear any scan status message after a delay
        setTimeout(() => { updateScanStatus(''); }, 4000);
         // Scroll to patient info section
         document.getElementById('patientInfo')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    // --- END QR SCANNER CODE ---


    // --- window.onload Check --- (Checks token and IPP)
    window.onload = () => {
      if (!localStorage.getItem('authToken')) {
          console.log("Billing Dash: No auth token, redirecting.");
          window.location.href = LOGIN_PAGE_URL; // Use absolute URL
          return;
      }
       document.body.classList.add('loaded'); // Show body
       console.log("Billing dashboard authenticated.");

       // Get IPP from URL - crucial for this page
       currentIPP = urlParams.get("ipp"); // Update global currentIPP

       if (!currentIPP) {
           // Option 1: Show message and disable functionality
           document.getElementById('patientInfo').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><div class="empty-state-message">IPP Patient Manquant</div><div class="empty-state-description">Veuillez charger un patient via l\'URL ou scanner un QR code.</div></div>';
           document.getElementById('factureBody').innerHTML = '<tr><td colspan="6" class="text-center">Chargez un patient pour voir l\'historique.</td></tr>';
           enableInvoiceSection(false); // Disable invoice creation
            // Option 2: Redirect back or show link to reception? (Depends on workflow)
            // showAlert("IPP du patient manquant dans l'URL.", "warning");
            console.warn("IPP missing from URL on load.");
       } else {
          // IPP exists in URL, proceed with initialization
          initializePage();
       }
    };

    // --- Initialize Page Function --- (Called if IPP exists on load)
    function initializePage() {
        console.log(`Initializing page for IPP: ${currentIPP}`);
        if (!currentIPP) return; // Double check
        loadPatientInfo(currentIPP); // Fetch patient info for IPP in URL
        loadServices();
        // loadInvoices(currentIPP); // loadPatientInfo calls this now
        $('#services').on('change', updateTotal);
        $('#creerFacture').on('click', createInvoice);
        console.log("Event listeners attached.");
    }

  </script>
</body>
</html>
