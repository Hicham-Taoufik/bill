<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Facturation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .select2-selection {
      min-height: 38px;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="text-primary text-center mb-4">Dashboard de Facturation</h2>

    <div id="patientInfo" class="mb-4"></div>

    <div class="mb-3">
      <label for="services" class="form-label fw-bold">Services Disponibles</label>
      <select id="services" class="form-select" multiple></select>
    </div>

    <div class="mb-3">
      <label for="modePaiement" class="form-label fw-bold">Mode de Paiement</label>
      <select id="modePaiement" class="form-select">
        <option value="espèces">Espèces</option>
        <option value="carte">Carte</option>
        <option value="virement">Virement</option>
      </select>
    </div>

    <p class="fw-bold">Total: <span id="total">0</span> MAD</p>

    <div class="mb-4">
      <button id="creerFacture" class="btn btn-primary me-2">Créer Facture</button>
      <button id="marquerPaye" class="btn btn-success">Marquer comme Payé</button>
    </div>

    <h5 class="fw-bold">Factures Existantes</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Montant</th>
            <th>Mode de Paiement</th>
            <th>Statut</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="facturesBody">
          <tr><td colspan="5">Chargement des factures...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    const baseUrl = 'https://workflows.aphelionxinnovations.com';
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWlkIjoiZmJmMmI1ZjctZTc3ZS00ZGZmLWJlN2UtN2ZlOGVkZmViZmY1IiwiZmlyc3ROYW1lIjoiTW91c3NhIiwibGFzdE5hbWUiOiJTYWlkaSIsInVzZXJuYW1lIjoic2FpZGkiLCJlbWFpbCI6Im1vdXNzYS5zYWlkaS4wMUBnbXppbC5jb20iLCJwYXNzd29yZCI6ImFkbWluMTIzNCIsInJvbGUiOiJBZG1pbiIsImlhdCI6MTc0Mjk1MjMyNn0.1s_IWO-h-AKwkP0LIX8mcjdeLRwsRtgbqAchIJSRVEA'; // Replace with your token

    const ipp = new URLSearchParams(window.location.search).get('ipp');
    let selectedServices = [];
    let servicesMap = new Map();
    let lastFactureId = null;

    async function fetchPatientInfo() {
      try {
        const res = await axios.get(`${baseUrl}/webhook/bill-get-patient?ipp=${ipp}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const p = res.data;
        document.getElementById('patientInfo').innerHTML = `
          <h5 class="fw-bold">Informations du Patient</h5>
          <p><strong>Nom:</strong> ${p.nom}</p>
          <p><strong>Prénom:</strong> ${p.prenom}</p>
          <p><strong>CIN:</strong> ${p.cin}</p>
          <p><strong>Téléphone:</strong> ${p.telephone}</p>
          <p><strong>Adresse:</strong> ${p.adresse}</p>
          <p><strong>Ville:</strong> ${p.ville}</p>
          <p><strong>Date de Naissance:</strong> ${p.date_naissance}</p>
          <p><strong>Sexe:</strong> ${p.sexe}</p>
          <p><strong>Mutuelle:</strong> ${p.mutuelle}</p>
        `;
      } catch (err) {
        alert("Erreur lors du chargement du patient.");
      }
    }

    async function fetchServices() {
      try {
        const res = await axios.get(`${baseUrl}/webhook/tarifs`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const list = res.data.services;
        servicesMap = new Map(list.map(s => [s.id, s]));

        $('#services').select2({
          data: list.map(s => ({ id: s.id, text: `${s.name} - ${parseFloat(s.price).toFixed(2)} MAD` })),
          placeholder: "Sélectionner des services..."
        });

        $('#services').on('change', function() {
          selectedServices = $(this).val().map(Number);
          updateTotal();
        });
      } catch (err) {
        alert("Erreur lors du chargement des services.");
      }
    }

    function updateTotal() {
      const total = selectedServices.reduce((sum, id) => {
        const srv = servicesMap.get(id);
        return sum + (srv ? parseFloat(srv.price) : 0);
      }, 0);
      document.getElementById("total").textContent = total.toFixed(2);
    }

    document.getElementById('creerFacture').addEventListener('click', async () => {
      try {
        const mode = document.getElementById('modePaiement').value;
        const body = { ipp, mode_paiement: mode, services: selectedServices };
        const res = await axios.post(`${baseUrl}/webhook/create-facture`, body, {
          headers: { Authorization: `Bearer ${token}` }
        });
        alert('Facture créée !');
        lastFactureId = res.data.facture_id;
        fetchFactures();
      } catch (err) {
        alert('Erreur création facture.');
      }
    });

    document.getElementById('marquerPaye').addEventListener('click', async () => {
      try {
        if (!lastFactureId) return alert("Créez d'abord une facture.");
        await axios.post(`${baseUrl}/webhook/facture/update-payment-status`, {
          facture_id: lastFactureId, etat_paiement: 'payé'
        }, {
          headers: { Authorization: `Bearer ${token}` }
        });
        alert('Statut mis à jour.');
        fetchFactures();
      } catch (err) {
        alert("Erreur statut.");
      }
    });

    async function fetchFactures() {
      try {
        const res = await axios.get(`${baseUrl}/webhook/factures?ipp=${ipp}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const factures = res.data;
        const tbody = document.getElementById('facturesBody');
        tbody.innerHTML = factures.map(f => `
          <tr>
            <td>${f.id}</td>
            <td>${f.montant} MAD</td>
            <td>${f.mode_paiement}</td>
            <td>${f.etat_paiement}</td>
            <td>${new Date(f.date_facturation).toLocaleDateString()}</td>
          </tr>`).join('');
      } catch (err) {
        document.getElementById('facturesBody').innerHTML = '<tr><td colspan="5">Erreur chargement des factures.</td></tr>';
      }
    }

    fetchPatientInfo();
    fetchServices();
    fetchFactures();
  </script>
</body>
</html>
