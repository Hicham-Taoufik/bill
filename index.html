<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MediClinic - Dashboard de Facturation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    /* --- CSS (No changes) --- */
    :root { --primary-color: #5469d4; --secondary-color: #7795f8; --success-color: #3ecf8e; --danger-color: #e25950; --warning-color: #f8b648; --info-color: #6baaee; --light-color: #f8f9fb; --dark-color: #212529; --light-gray: #eaecef; --border-radius: 0.75rem; --box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.06); --transition: all 0.3s ease; }
    body { background-color: #f9fafc; font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; padding: 0; margin: 0; min-height: 100vh; color: #324054; visibility: hidden; }
    body.loaded { visibility: visible; }
    .app-container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray); }
    .page-title { color: var(--primary-color); font-weight: 600; margin: 0; font-size: 1.75rem; }
    .clinic-logo { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; color: var(--primary-color); }
    .clinic-logo img { height: 35px; width: auto; margin-right: 10px; } /* Style for logo image */
    .card { border: none; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 1.5rem; transition: var(--transition); overflow: hidden; }
    .card:hover { box-shadow: 0 0.75rem 2rem rgba(0, 0, 0, 0.12); }
    .card-header { background-color: #fff; border-bottom: 1px solid var(--light-gray); padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-weight: 600; margin: 0; color: var(--dark-color); font-size: 1.1rem; }
    .card-body { padding: 1.5rem; }
    .card-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: white; font-size: 1.2rem; }
    .icon-patient { background: linear-gradient(45deg, #6772e5, #5469d4); }
    .icon-invoice { background: linear-gradient(45deg, #3ecf8e, #2fbe7f); }
    .icon-history { background: linear-gradient(45deg, #f8b653, #f7a429); }
    .patient-info { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .patient-info-item { margin-bottom: 0.5rem; }
    .patient-info-label { color: #8792a2; font-size: 0.875rem; margin-bottom: 0.25rem; }
    .patient-info-value { font-weight: 500; font-size: 1rem; }
    .select2-container { width: 100% !important; }
    .select2-container--default .select2-selection--multiple { border-color: #ced4da; border-radius: 0.375rem; min-height: 38px; }
    .select2-container--default.select2-container--focus .select2-selection--multiple { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(84, 105, 212, 0.25); }
    .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: var(--primary-color); border: none; color: white; border-radius: 20px; padding: 2px 10px; }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: white; margin-right: 5px; }
    .form-control, .form-select { border-radius: 0.5rem; padding: 0.6rem 1rem; border: 1px solid #dfe3e8; }
    .form-control:focus, .form-select:focus { box-shadow: 0 0 0 0.25rem rgba(84, 105, 212, 0.25); border-color: var(--primary-color); }
    .form-group label { font-weight: 500; margin-bottom: 0.5rem; color: #506690; }
    .btn { border-radius: 0.5rem; padding: 0.6rem 1.5rem; font-size: 0.85rem; font-weight: 500; transition: background-color 0.2s ease; border: none; }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover, .btn-primary:focus { background-color: #465bbf; border-color: #465bbf; }
    .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
    .btn-success:hover, .btn-success:focus { background-color: #2fbe7f; border-color: #2fbe7f; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-secondary:hover { background-color: #495057; }
    .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-bar input { flex-grow: 1; }
    #getResult { margin-top: 20px; background: #f1f3f5; padding: 20px; border-radius: 12px; border-left: 4px solid #007BFF; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .mutuelle-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; grid-column: span 2; }
    img.qrcode { max-width: 300px; margin-top: 20px; }

    @media (max-width: 768px) {
      .flex-row { flex-direction: column; gap: 20px; }
      .patient-info { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body > <!-- Body starts hidden -->
  <div class="loader-container"> <div class="loader"></div> </div>
  <div class="app-container">
    <div class="page-header no-print">
        <h1 class="page-title">Dashboard de Facturation</h1>
        <div class="clinic-logo">
            <img src="./clinique-nakhil-logo-horizontal.webp" alt="MediClinic Logo" style="height: 35px; width: auto; margin-right: 10px;">
            <button onclick="logout()" style="margin-left: 20px;" title="Déconnexion" class="btn btn-sm btn-outline"> <i class="fas fa-sign-out-alt"></i> Déconnexion </button>
        </div>
    </div>
    <div id="alertContainer" class="alert no-print" role="alert"></div>
    <div class="card no-print">
        <div class="card-header"> <h5 class="card-title">Informations du Patient</h5> <div class="card-icon icon-patient"> <i class="fas fa-user"></i> </div> </div>
        <div class="card-body"> <div id="patientInfo" class="patient-info"> <div class="empty-state"> <i class="fas fa-user-circle"></i> <div class="empty-state-message">Aucun patient chargé</div> <div class="empty-state-description">Scannez un QR code ou chargez via l'URL (IPP).</div> </div> </div> </div>
    </div>
    <div class="card no-print">
        <div class="card-header"> <h5 class="card-title">Nouvelle Facture</h5> <div class="card-icon icon-invoice"> <i class="fas fa-file-invoice"></i> </div> </div>
        <div class="card-body"> <div class="row"> <div class="col-md-8"> <div class="form-group mb-4"> <label for="services"><i class="fas fa-list-check me-2"></i>Services Disponibles</label> <select class="form-select" id="services" multiple></select> </div> <div class="form-group mb-4"> <label for="modePaiement"><i class="fas fa-credit-card me-2"></i>Mode de Paiement</label> <select class="form-select" id="modePaiement"> <option value="espèces">Espèces</option> <option value="carte">Carte Bancaire</option> <option value="assurance">Assurance</option> </select> </div> </div> <div class="col-md-4"> <div class="price-card"> <div class="price-label">Montant Total</div> <div class="price-value"><span id="total">0.00</span><span class="price-currency">MAD</span></div> <button id="creerFacture" class="btn btn-light w-100 mt-3" disabled> <i class="fas fa-plus-circle me-2"></i>Créer Facture </button> </div> </div> </div> </div>
    </div>
    <div class="card no-print">
        <div class="card-header"> <h5 class="card-title">Historique des Factures</h5> <div class="card-icon icon-history"> <i class="fas fa-history"></i> </div> </div>
        <div class="card-body"> <div class="table-responsive"> <table class="table"> <thead> <tr> <th>ID</th> <th>Montant</th> <th>Mode de Paiement</th> <th>Statut</th> <th>Date</th> <th class="no-print" style="width: 25%;">Action</th> </tr> </thead> <tbody id="factureBody"> <tr> <td colspan="6" class="text-center">Chargement des factures...</td> </tr> </tbody> </table> </div> </div>
    </div>
  </div>

  <!-- Hidden div for PDF generation -->
  <div id="invoice-content-area" style="position: absolute; left: -9999px; top: -9999px;"></div>
  <!-- Hidden iframe for printing -->
  <iframe id="print-frame" name="print-frame" style="position:absolute;top:-9999px;left:-9999px;"></iframe>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    // --- Configuration
    const baseUrl = "https://workflows.aphelionxinnovations.com";
    const token = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWlkIjoiZmJmMmI1ZjctZTc3ZS00ZGZmLWJlN2UtN2ZlOGVkZmViZmY1IiwiZmlyc3ROYW1lIjoiTW91c3NhIiwibGFzdE5hbWUiOiJTYWlkaSIsInVzZXJuYW1lIjoic2FpZGkiLCJlbWFpbCI6Im1vdXNzYS5zYWlkaS4wMUBnbXppbC5jb20iLCJwYXNzd29yZCI6ImFkbWluMTIzNCIsInJvbGUiOiJBZG1pbiIsImlhdCI6MTc0Mjk1MjMyNn0.1s_IWO-h-AKwkP0LIX8mcjdeLRwsRtgbqAchIJSRVEA"; // Replace with your actual token
    let currentIPP = null;

    // Optional: Add Clinic Info here
    const clinicInfo = {
        name: "MediClinic",
        address: "123 Rue de la Santé, Paris",
        phone: "+33 1 23 45 67 89",
        logoUrl: "url/to/your/logo.png" // Optional
    };

    // Helper functions
    function showLoader() { document.querySelector('.loader-container').style.display = 'flex'; }
    function hideLoader() { document.querySelector('.loader-container').style.display = 'none'; }
    function showAlert(message, type = 'danger') {
        const alertElement = document.getElementById('alertContainer'); alertElement.className = `alert alert-${type} no-print`; alertElement.innerHTML = `<i class="${type === 'danger' ? 'fas fa-exclamation-circle' : type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'} me-2"></i>${message}`; alertElement.style.display = 'block'; alertElement.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => { alertElement.style.display = 'none'; }, 5000); }

    // API service layer
    const apiService = {
        async fetchPatient(patientIpp) { try { const res = await fetch(`${baseUrl}/webhook/bill-get-patient?ipp=${patientIpp}`, { headers: { Authorization: token } }); if (!res.ok) throw new Error('Erreur réseau'); return await res.json(); } catch (e) { console.error("Error fetching patient:", e); showAlert('Erreur lors du chargement des informations du patient.'); throw e; } },
        async fetchServices() { try { const res = await fetch(`${baseUrl}/webhook/tarifs`, { headers: { Authorization: token } }); if (!res.ok) throw new Error('Erreur réseau'); return await res.json(); } catch (e) { console.error("Error fetching services:", e); showAlert('Erreur lors du chargement des services.'); throw e; } },
        async createInvoice(data) { try { const res = await fetch(`${baseUrl}/webhook/create-facture`, { method: 'POST', headers: { 'Authorization': token, 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (!res.ok) throw new Error('Erreur réseau'); return await res.json(); } catch (e) { console.error("Error creating invoice:", e); showAlert('Erreur lors de la création de la facture.'); throw e; } },
        async getInvoicesByIpp(patientIpp) { try { const res = await fetch(`${baseUrl}/webhook/facture/get-by-ipp?ipp=${patientIpp}`, { headers: { Authorization: token } }); if (!res.ok) throw new Error('Erreur réseau'); return await res.json(); } catch (e) { console.error("Error fetching invoices:", e); showAlert('Erreur lors du chargement de l\'historique des factures.'); throw e; } },
        async updatePaymentStatus(factureId, etat_paiement) { try { const res = await fetch(`${baseUrl}/webhook/facture/update-payment-status`, { method: 'POST', headers: { 'Authorization': token, 'Content-Type': 'application/json' }, body: JSON.stringify({ facture_id: factureId, etat_paiement: etat_paiement.toLowerCase() }) }); if (!res.ok) throw new Error('Erreur réseau'); return await res.json(); } catch (e) { console.error("Error updating payment status:", e); showAlert('Erreur lors de la mise à jour du statut de paiement.'); throw e; } },
        async getInvoiceDetails(factureId) { if (isNaN(factureId)) throw new Error("Facture ID non valide."); try { const res = await fetch(`${baseUrl}/webhook/facture/get?facture_id=${factureId}`, { headers: { Authorization: token } }); if (!res.ok) throw new Error('Erreur réseau'); return await res.json(); } catch (e) { console.error("Error fetching invoice details:", e); showAlert('Erreur lors du chargement des détails de la facture.'); throw e; } }
    };

    // Formatters
    function formatPaymentMode(mode) { switch(mode?.toLowerCase()){case'espèces':return'Espèces';case'carte':return'Carte Bancaire';case'assurance':return'Assurance';default:return mode||'N/A';} }
    function getPaymentIcon(mode) { switch(mode?.toLowerCase()){case'espèces':return'fas fa-money-bill-wave';case'carte':return'fas fa-credit-card';case'assurance':return'fas fa-shield-alt';default:return'fas fa-circle';} }
    function formatService(service) { try{const d=JSON.parse(service.id);return $(`<div class="d-flex justify-content-between align-items-center"><span>${d.name}</span><span class="badge bg-primary">${parseFloat(d.price).toFixed(2)} MAD</span></div>`);}catch(e){return service.text;} }
    function formatServiceSelection(service) { try{const d=JSON.parse(service.element.value);return d.name;}catch(e){return service.text;} }

    // UI functions
    async function loadPatientInfo() { if(!ipp){showAlert("IPP manquant...");return;} showLoader();try{const d=await apiService.fetchPatient(ipp); for(const k in d){const el=document.getElementById(k);if(el){el.textContent=d[k]||'-';}}}catch(e){showAlert('Erreur lors du chargement des informations du patient.');}finally{hideLoader();} }
    async function loadServices() { showLoader(); try { const r = await apiService.fetchServices(); const s = r.services; const sel = document.getElementById("services"); sel.innerHTML = ''; s.forEach(svc => { if (svc.id && svc.name && svc.price) { const opt = new Option(`${svc.name} - ${svc.price} MAD`, JSON.stringify(svc)); sel.append(opt); } }); $('#services').select2({ placeholder: "Sélectionner...", allowClear: true, templateResult: formatService, templateSelection: formatServiceSelection }); } catch (e) { showAlert('Erreur lors du chargement des services.'); } finally { hideLoader(); } }
    function updateTotal() { try{const d=$('#services').select2("data");let t=0;d.forEach(s=>{try{const sd=JSON.parse(s.id);t+=parseFloat(sd.price);}catch(e){}});document.getElementById("total").textContent=t.toFixed(2);}catch(e){console.error("Error updating total:", e);} }
    async function createInvoice() { const s=$('#services').select2("data");if(s.length===0){showAlert("Veuillez sélectionner au moins un service.");return;}let ids=[];s.forEach(i=>{try{ids.push(JSON.parse(i.id).id);}catch(e){}});const p=document.getElementById("modePaiement").value;showLoader();try{await apiService.createInvoice({ipp:ipp,mode_paiement:p,services:ids}); $('#services').val(null).trigger('change'); updateTotal(); showAlert("Facture créée avec succès!", 'success'); loadInvoices(); } catch (e) { showAlert('Erreur lors de la création de la facture.'); } finally { hideLoader(); } }
    async function loadInvoices() { showLoader(); try { const resp = await apiService.getInvoicesByIpp(ipp); const invoices = resp.factures; const tableBody = document.getElementById("factureBody"); tableBody.innerHTML = ''; invoices.forEach(invoice => { const row = document.createElement("tr"); row.innerHTML = `
              <td>${invoice.id}</td>
              <td>${invoice.montant} MAD</td>
              <td class="payment-method"><i class="${getPaymentIcon(invoice.mode_paiement)}"></i>${formatPaymentMode(invoice.mode_paiement)}</td>
              <td><span class="badge ${invoice.etat_paiement === 'payé' ? 'badge-paid' : 'badge-pending'}">${invoice.etat_paiement === 'payé' ? 'Payé' : 'En attente'}</span></td>
              <td>${new Date(invoice.date_facturation).toLocaleDateString()}</td>
              <td class="no-print">
                  <button onclick="updateInvoiceStatus(${invoice.id}, '${invoice.etat_paiement === 'payé' ? 'en attente' : 'payé'}')" class="btn btn-sm btn-outline-success">${invoice.etat_paiement === 'payé' ? 'Marquer en attente' : 'Marquer payé'}</button>
                  <button onclick="handleDownloadPdf(${invoice.id})" class="btn btn-sm btn-outline-primary">Télécharger PDF</button>
                  <button onclick="handlePrintInvoice(${invoice.id})" class="btn btn-sm btn-outline-secondary">Imprimer</button>
              </td>
          `; tableBody.append(row); }); } catch (e) { showAlert('Erreur lors du chargement de l\'historique des factures.'); } finally { hideLoader(); } }
    async function updateInvoiceStatus(id, status) { showLoader(); try { await apiService.updatePaymentStatus(id, status); showAlert('Statut de la facture mis à jour avec succès!', 'success'); loadInvoices(); } catch (e) { showAlert('Erreur lors de la mise à jour du statut de la facture.'); } finally { hideLoader(); } }
    async function handleDownloadPdf(factureId) { showLoader(); try { const invoiceDetails = await apiService.getInvoiceDetails(factureId); const element = document.getElementById('invoice-content-area'); element.innerHTML = generateInvoiceHtml(invoiceDetails); const opt = { margin: 0.5, filename: `facture-${factureId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }; await html2pdf().set(opt).from(element).save(); showAlert("PDF téléchargé avec succès!", "success"); } catch (error) { console.error("Error generating PDF:", error); showAlert('Erreur lors de la génération du PDF.'); } finally { hideLoader(); } }
    async function handlePrintInvoice(factureId) { showLoader(); try { const invoiceDetails = await apiService.getInvoiceDetails(factureId); const element = document.getElementById('invoice-content-area'); element.innerHTML = generateInvoiceHtml(invoiceDetails); const opt = { margin: 0, filename: `facture-${factureId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }; const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob'); const pdfUrl = URL.createObjectURL(pdfBlob); document.getElementById('print-frame').src = pdfUrl; showAlert("Impression lancée!", "success"); } catch (error) { console.error("Error preparing for printing:", error); showAlert('Erreur lors de la préparation de l\'impression.'); } finally { hideLoader(); } }

    function generateInvoiceHtml(invoiceDetails) {
        return `
      <div class="invoice-box">
          <table>
              <tr class="top">
                  <td colspan="2">
                      <table>
                          <tr>
                              <td class="title">
                                  <img src="logo.webp" style="width:100%; max-width:300px;">
                              </td>
                              <td>
                                  Facture #: ${invoiceDetails.id}<br>
                                  Créée le: ${new Date(invoiceDetails.date_facturation).toLocaleDateString()}<br>
                              </td>
                          </tr>
                      </table>
                  </td>
              </tr>
              <tr class="information">
                  <td colspan="2">
                      <table>
                          <tr>
                              <td>
                                  ${clinicInfo.name}<br>
                                  ${clinicInfo.address}<br>
                                  ${clinicInfo.phone}
                              </td>
                              <td>
                                  ${document.getElementById('nom').textContent} ${document.getElementById('prenom').textContent}<br>
                                  ${document.getElementById('adresse').textContent}<br>
                                  ${document.getElementById('ville').textContent}<br>
                                  ${document.getElementById('telephone').textContent}
                              </td>
                          </tr>
                      </table>
                  </td>
              </tr>
              <tr class="heading">
                  <td>Service</td>
                  <td>Prix</td>
              </tr>
              <tr class="item">
                  <td>Consultation</td>
                  <td>300.00 MAD</td>
              </tr>
              <tr class="total">
                  <td></td>
                  <td> Total: 300.00 MAD
                  </td>
              </tr>
          </table>
      </div>
      `;
    }

    async function initializePage() {
      try {
        showLoader();
        await loadPatientInfo();
        await loadServices();
        await loadInvoices();
      } catch (error) {
        console.error("Page initialization error:", error);
        showAlert('Erreur lors du chargement initial de la page.');
      } finally {
        hideLoader();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      initializePage();
    });

  </script>
</body>
</html>
